<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì˜¤ì‘êµ(OJK) API í…ŒìŠ¤í„°</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: #f4f4f9; }
        h1, h2 { color: #333; text-align: center; }
        .card { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        input, select, button { padding: 10px; margin: 5px 0; width: 100%; box-sizing: border-box; border: 1px solid #ddd; border-radius: 4px; }
        button { background-color: #5c6bc0; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #3f51b5; }
        button.secondary { background-color: #eee; color: #333; }
        button.path-btn { background-color: #ff9800; }
        button.path-btn:hover { background-color: #f57c00; }
        .row { display: flex; gap: 10px; }
        pre { background: #333; color: #0f0; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; }
        .result-item { border-bottom: 1px solid #eee; padding: 10px 0; display: flex; justify-content: space-between; align-items: center; }
        .path-result { margin-top: 10px; padding: 10px; background-color: #e3f2fd; border-radius: 4px; color: #0d47a1; font-weight: bold; }
    </style>
</head>
<body>

<h1>ì˜¤ì‘êµ API í…ŒìŠ¤í„°</h1>

<div id="auth-section">
    <div class="card">
        <h2>1. ì´ë©”ì¼ ì¸ì¦ & ê°€ì…</h2>
        <input type="email" id="signup-email" placeholder="í•™êµ ì´ë©”ì¼ (ì˜ˆ: test@dankook.ac.kr)" value="test@dankook.ac.kr">
        <div class="row">
            <button onclick="sendEmail()">ì¸ì¦ë²ˆí˜¸ ë°œì†¡</button>
            <button class="secondary" onclick="verifyEmail()">ê°œë°œì í”„ë¦¬íŒ¨ìŠ¤(000000)</button>
        </div>
        <hr>
        <input type="text" id="signup-name" placeholder="ì´ë¦„" value="í™ê¸¸ë™">
        <input type="password" id="signup-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" value="1234">
        <div class="row">
            <input type="number" id="signup-year" placeholder="í•™ë²ˆ(2024)" value="2024">
            <input type="text" id="signup-college" placeholder="ë‹¨ê³¼ëŒ€(ê³µê³¼ëŒ€í•™)" value="ê³µê³¼ëŒ€í•™">
        </div>
        <input type="text" id="signup-major" placeholder="ì „ê³µ(ì†Œí”„íŠ¸ì›¨ì–´í•™ê³¼)" value="ì†Œí”„íŠ¸ì›¨ì–´í•™ê³¼">
        <button onclick="signup()">íšŒì›ê°€ì… í•˜ê¸°</button>
    </div>

    <div class="card">
        <h2>2. ë¡œê·¸ì¸</h2>
        <input type="email" id="login-email" placeholder="ì´ë©”ì¼" value="test@dankook.ac.kr">
        <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸" value="1234">
        <button onclick="login()">ë¡œê·¸ì¸</button>
    </div>
</div>

<div id="main-section" class="hidden">
    <div class="card" style="background: #e8eaf6; border: 1px solid #c5cae9;">
        <h3>ğŸ‘‹ í™˜ì˜í•©ë‹ˆë‹¤, <span id="user-name-display"></span>ë‹˜!</h3>
        <p>ë‚´ ID: <span id="my-id-display"></span> | í† í° ë³´ìœ ì¤‘</p>
        <button class="secondary" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
    </div>

    <div class="card">
        <h2>3. ì¹œêµ¬ ê²€ìƒ‰ & íŒ”ë¡œìš° & ê²½ë¡œíƒìƒ‰</h2>
        <div class="row">
            <input type="text" id="search-keyword" placeholder="ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰">
            <button onclick="searchMember()">ê²€ìƒ‰</button>
        </div>
        <div id="search-results"></div>
        <div id="path-display" class="hidden path-result"></div>
    </div>

    <div class="card">
        <h2>4. API ì‘ë‹µ ë¡œê·¸</h2>
        <pre id="api-log">API ìš”ì²­ ëŒ€ê¸°ì¤‘...</pre>
    </div>
</div>

<script>
    let accessToken = null;
    let myId = null;

    const API_BASE = `${window.location.origin}/api`;

    // --- 1. ì¸ì¦ ê´€ë ¨ í•¨ìˆ˜ ---
    async function sendEmail() {
        const email = document.getElementById('signup-email').value;
        callApi('/auth/email/send', 'POST', { email });
    }

    async function verifyEmail() {
        const email = document.getElementById('signup-email').value;
        callApi('/auth/email/verify', 'POST', { email, code: '000000' });
    }

    async function signup() {
        const data = {
            email: document.getElementById('signup-email').value,
            password: document.getElementById('signup-pw').value,
            name: document.getElementById('signup-name').value,
            admissionYear: parseInt(document.getElementById('signup-year').value),
            college: document.getElementById('signup-college').value,
            majorName: document.getElementById('signup-major').value,
            bio: "í…ŒìŠ¤íŠ¸ ê³„ì •ì…ë‹ˆë‹¤."
        };
        callApi('/auth/signup', 'POST', data);
    }

    async function login() {
        const data = {
            email: document.getElementById('login-email').value,
            password: document.getElementById('login-pw').value
        };

        const result = await callApi('/auth/login', 'POST', data);
        if (result && result.accessToken) {
            accessToken = result.accessToken;

            const payload = decodeJwtPayload(accessToken);
            myId = payload?.id ?? null;
            const email = payload?.sub ?? data.email;

            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('main-section').classList.remove('hidden');
            document.getElementById('my-id-display').innerText = myId ?? 'í™•ì¸ ë¶ˆê°€';
            document.getElementById('user-name-display').innerText = email;

            log(`ë¡œê·¸ì¸ ì„±ê³µ! Token ì €ì¥ë¨. (My ID: ${myId})`);
        }
    }

    function decodeJwtPayload(token) {
        try {
            const payloadPart = token.split('.')[1];
            if (!payloadPart) return null;

            const normalized = payloadPart
                .replace(/-/g, '+')
                .replace(/_/g, '/');
            const padded = normalized + '='.repeat((4 - (normalized.length % 4)) % 4);

            return JSON.parse(atob(padded));
        } catch (e) {
            log(`âš ï¸ í† í° íŒŒì‹± ì‹¤íŒ¨: ${e}`);
            return null;
        }
    }

    function logout() {
        accessToken = null;
        myId = null;
        location.reload();
    }

    // --- 2. íšŒì› ê¸°ëŠ¥ í•¨ìˆ˜ ---
    async function searchMember() {
        const keyword = document.getElementById('search-keyword').value;
        const data = await callApi(`/member/${keyword}`, 'GET');

        const list = document.getElementById('search-results');
        list.innerHTML = '';
        document.getElementById('path-display').classList.add('hidden'); // ê¸°ì¡´ ê²½ë¡œ ìˆ¨ê¹€

        if (data && data.length > 0) {
            data.forEach(member => {
                const isMe = (member.id === myId);

                let buttonsHtml = '';
                if (!isMe) {
                    buttonsHtml = `
                            <div class="row" style="gap:5px;">
                                <button onclick="followUser(${member.id})" style="font-size:12px; padding:5px;">íŒ”ë¡œìš°</button>
                                <button class="path-btn" onclick="checkPath(${member.id}, '${member.name}')" style="font-size:12px; padding:5px;">ê²½ë¡œ í™•ì¸</button>
                            </div>
                        `;
                } else {
                    buttonsHtml = '<span style="color:blue; font-weight:bold;">(ë‚˜)</span>';
                }

                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `
                        <div>
                            <strong>${member.name}</strong> (${member.majorName}, ${member.admissionYear})<br>
                            <small>${member.email}</small>
                        </div>
                        <div>
                            ${buttonsHtml}
                        </div>
                    `;
                list.appendChild(div);
            });
        } else {
            list.innerHTML = '<p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }

    async function followUser(targetId) {
        if (!confirm(`ì •ë§ íŒ”ë¡œìš° í•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ID: ${targetId})`)) return;
        await callApi(`/member/${myId}/follow/${targetId}`, 'POST');
        alert("íŒ”ë¡œìš° ì„±ê³µ!");
    }

    // [ì¶”ê°€ëœ ê¸°ëŠ¥] ìµœë‹¨ ê²½ë¡œ í™•ì¸
    async function checkPath(targetId, targetName) {
        const pathDiv = document.getElementById('path-display');
        pathDiv.innerHTML = 'ê²½ë¡œ ê³„ì‚° ì¤‘... â³';
        pathDiv.classList.remove('hidden');

        // API í˜¸ì¶œ: /api/member/path?startId={myId}&endId={targetId}
        const data = await callApi(`/member/path?startId=${myId}&endId=${targetId}`, 'GET');

        if (data && Array.isArray(data) && data.length > 0) {
            // ê²½ë¡œ ì‹œê°í™” (A -> B -> C)
            const names = data.map(m => m.name).join(' â¡ï¸ ');
            pathDiv.innerHTML = `ğŸš€ ìµœë‹¨ ê²½ë¡œ: <br>${names} <br><small>(ì´ ${data.length - 1}ë‹¨ê³„)</small>`;
        } else {
            pathDiv.innerHTML = `ğŸš« ${targetName}ë‹˜ê³¼ëŠ” ì—°ê²°ëœ ê²½ë¡œê°€ ì—†ìŠµë‹ˆë‹¤.`;
        }
    }

    // --- ê³µí†µ ìœ í‹¸ ---
    async function callApi(endpoint, method, body = null) {
        const headers = { 'Content-Type': 'application/json' };
        // SecurityConfigì—ì„œ permitAll() í–ˆìœ¼ë©´ ì—†ì–´ë„ ë˜ì§€ë§Œ, í˜¹ì‹œ ëª¨ë¥´ë‹ˆ ë„£ìŒ
        if (accessToken) headers['Authorization'] = `Bearer ${accessToken}`;

        const options = { method, headers };
        if (body && method !== 'GET') options.body = JSON.stringify(body);

        log(`[${method}] ${endpoint} ìš”ì²­ ì¤‘...`);

        try {
            const res = await fetch(API_BASE + endpoint, options);
            const text = await res.text();
            let result = null;

            try {
                result = JSON.parse(text);
            } catch (e) {
                result = text;
            }

            if (res.ok) {
                log(`âœ… ì„±ê³µ: ${JSON.stringify(result, null, 2)}`);
                return result;
            } else {
                log(`âŒ ì‹¤íŒ¨: ${text}`); // ì—ëŸ¬ ë©”ì‹œì§€ ê·¸ëŒ€ë¡œ ì¶œë ¥
                return null; // ì‹¤íŒ¨ ì‹œ null ë°˜í™˜
            }
        } catch (err) {
            log(`ğŸ”¥ ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬: ${err}`);
            alert("ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            return null;
        }
    }

    function log(msg) {
        const logBox = document.getElementById('api-log');
        logBox.innerText = msg;
        console.log(msg);
    }
</script>
</body>
</html>
